

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/%E5%A4%B4%E5%83%8F.jpeg">
  <link rel="icon" href="/img/%E5%A4%B4%E5%83%8F.jpeg">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Lluvia Luo">
  <meta name="keywords" content="">
  
    <meta name="description" content="本文详细介绍了C++编译与链接的过程，包括预处理、编译、汇编和链接四个阶段。预处理阶段处理源代码中的预处理指令，如包含头文件和宏替换；编译阶段将预处理后的代码转换为汇编语言；汇编阶段将汇编代码转换为机器语言，生成可重定位目标程序；链接阶段将多个目标文件合并，解析符号引用，生成可执行文件。此外，文章还讨论了库文件的静态链接和动态链接，以及动态链接中的位置无关代码和延迟绑定机制。">
<meta property="og:type" content="article">
<meta property="og:title" content="C++编译与链接">
<meta property="og:url" content="https://lluvialuo.github.io/2024/05/21/C-%E7%BC%96%E8%AF%91%E4%B8%8E%E9%93%BE%E6%8E%A5/index.html">
<meta property="og:site_name" content="Lluvia&#39;s blog">
<meta property="og:description" content="本文详细介绍了C++编译与链接的过程，包括预处理、编译、汇编和链接四个阶段。预处理阶段处理源代码中的预处理指令，如包含头文件和宏替换；编译阶段将预处理后的代码转换为汇编语言；汇编阶段将汇编代码转换为机器语言，生成可重定位目标程序；链接阶段将多个目标文件合并，解析符号引用，生成可执行文件。此外，文章还讨论了库文件的静态链接和动态链接，以及动态链接中的位置无关代码和延迟绑定机制。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://lluvialuo.github.io/2024/05/21/C-%E7%BC%96%E8%AF%91%E4%B8%8E%E9%93%BE%E6%8E%A5/%E7%BC%96%E8%AF%91%E9%93%BE%E6%8E%A5%E6%B5%81%E7%A8%8B.png">
<meta property="og:image" content="https://lluvialuo.github.io/2024/05/21/C-%E7%BC%96%E8%AF%91%E4%B8%8E%E9%93%BE%E6%8E%A5/ELF%E6%96%87%E4%BB%B6.png">
<meta property="og:image" content="https://lluvialuo.github.io/2024/05/21/C-%E7%BC%96%E8%AF%91%E4%B8%8E%E9%93%BE%E6%8E%A5/%E7%AC%A6%E5%8F%B7%E8%A1%A8%E6%9D%A1%E7%9B%AE.png">
<meta property="og:image" content="https://lluvialuo.github.io/2024/05/21/C-%E7%BC%96%E8%AF%91%E4%B8%8E%E9%93%BE%E6%8E%A5/%E9%87%8D%E5%AE%9A%E4%BD%8D%E6%9D%A1%E7%9B%AE.png">
<meta property="og:image" content="https://lluvialuo.github.io/2024/05/21/C-%E7%BC%96%E8%AF%91%E4%B8%8E%E9%93%BE%E6%8E%A5/%E9%87%8D%E5%AE%9A%E4%BD%8D%E7%AE%97%E6%B3%95.png">
<meta property="og:image" content="https://lluvialuo.github.io/2024/05/21/C-%E7%BC%96%E8%AF%91%E4%B8%8E%E9%93%BE%E6%8E%A5/PIC%E6%95%B0%E6%8D%AE%E5%BC%95%E7%94%A8.png">
<meta property="og:image" content="https://lluvialuo.github.io/2024/05/21/C-%E7%BC%96%E8%AF%91%E4%B8%8E%E9%93%BE%E6%8E%A5/PIC%E5%87%BD%E6%95%B0%E5%BC%95%E7%94%A8.png">
<meta property="article:published_time" content="2024-05-21T02:35:53.000Z">
<meta property="article:modified_time" content="2024-05-21T03:02:58.423Z">
<meta property="article:author" content="Lluvia Luo">
<meta property="article:tag" content="C&#x2F;C++">
<meta property="article:tag" content="编译链接">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://lluvialuo.github.io/2024/05/21/C-%E7%BC%96%E8%AF%91%E4%B8%8E%E9%93%BE%E6%8E%A5/%E7%BC%96%E8%AF%91%E9%93%BE%E6%8E%A5%E6%B5%81%E7%A8%8B.png">
  
  
  
  <title>C++编译与链接 - Lluvia&#39;s blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"lluvialuo.github.io","root":"/","version":"1.9.7","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":"GYXWwiquLells7Jk5YnXDL14-gzGzoHsz","app_key":"ZwOt64lE5AeeAOjGF9nhJl9b","server_url":"https://gyxwwiqu.lc-cn-n1-shared.com","path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  

  
    <!-- Google tag (gtag.js) -->
    <script async>
      if (!Fluid.ctx.dnt) {
        Fluid.utils.createScript("https://www.googletagmanager.com/gtag/js?id=", function() {
          window.dataLayer = window.dataLayer || [];
          function gtag() {
            dataLayer.push(arguments);
          }
          gtag('js', new Date());
          gtag('config', '');
        });
      }
    </script>
  

  

  

  

  
    
  



  
<meta name="generator" content="Hexo 7.2.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Lluvia</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/mainpage.jpg') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="C++编译与链接"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2024-05-21 10:35" pubdate>
          2024年5月21日 上午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          5.6k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          47 分钟
        
      </span>
    

    
    
      
        <span id="leancloud-page-views-container" class="post-meta" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="leancloud-page-views"></span> 次
        </span>
        
      
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">C++编译与链接</h1>
            
              <p id="updated-time" class="note note-info" style="">
                
                  
                    本文最后更新于 2024年5月21日 上午
                  
                
              </p>
            
            
              <div class="markdown-body">
                
                <p>C++编译与链接</p>
<blockquote>
<p>参考资料：</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://taifua.com/c-cpp-compilation-process.html">C &#x2F; C++程序编译过程</a></li>
<li><a target="_blank" rel="noopener" href="https://juejin.cn/post/7043778638802518052">浅析C&#x2F;C++编译流程</a></li>
<li>《深入理解计算机系统》第七章</li>
</ol>
</blockquote>
<h1 id="一、概述"><a href="#一、概述" class="headerlink" title="一、概述"></a>一、概述</h1><div style="text-align:center;">
    <img src="编译链接流程.png" srcset="/img/loading.gif" lazyload alt="编译链接流程.png" width="649" height="123" class="jop-noMdConv">
</div>

<ul>
<li>简单来说，C&#x2F;C++编译的整个过程分为四个阶段：<strong>预处理（Pre-Processing）</strong>、<strong>编译（Compilation）</strong>、<strong>汇编（Assembling）</strong>、<strong>链接（Linking)</strong></li>
<li>其中<strong>源程序、修改了的源程序和汇编程序</strong>都是<strong>文本文件</strong>，而<strong>可重定位目标程序和可执行目标程序</strong>都是<strong>二进制文件</strong>。</li>
</ul>
<h1 id="二、编译"><a href="#二、编译" class="headerlink" title="二、编译"></a>二、编译</h1><h2 id="2-1-预处理"><a href="#2-1-预处理" class="headerlink" title="2.1 预处理"></a>2.1 预处理</h2><ul>
<li>预处理阶段做的事情就是预处理器（cpp）根据以字符<code>#</code>开头的代码修改原始的C程序。<ul>
<li>比如<code>#include &lt;stdio.h&gt;</code>，将头文件<strong>stdio.h</strong>中的内容加到程序文本中</li>
<li>比如<code>#define info &quot;Hello, world\n&quot;</code>，会将宏定义的<strong>info</strong>替换成字符串<code>&quot;Hello, world\\n&quot;</code>（当然我这里只是为了举例，一般我们不这么写）</li>
<li>此外，会将注释比如<code>// A simple program.</code>删除</li>
</ul>
</li>
<li>预处理是直接对源文件进行处理（不关注语法规则）， 然后得到另一个C程序，通常以<code>.i</code>作为文件扩展名。</li>
<li>可以在Linux系统（我这里用的是Ubuntu）下直接使用<code>gcc -E main.c -o main.i</code>命令得到预处理后的C程序<code>main.i</code>。</li>
</ul>
<h2 id="2-2-编译"><a href="#2-2-编译" class="headerlink" title="2.2 编译"></a>2.2 编译</h2><ul>
<li>编译阶段做的事情就是编译器（cc1）将C程序<code>main.i</code>翻译成汇编语言程序<code>main.s</code>:<ul>
<li>检查C程序的语法错误</li>
<li>将文件翻译成中间代码，即汇编语言</li>
<li>可选地优化翻译后的中间代码，获得更好的性能</li>
</ul>
</li>
<li>可以使用<code>gcc -S main.i -o main.s</code>得到翻译后的汇编程序<code>main.s</code></li>
<li>汇编语言是有用的，它为不同高级语言的不同汇编器提供了通用的输出语言，C汇编器和Fortran汇编器产生的输出文件都是一样的汇编语言。</li>
</ul>
<h2 id="2-3-汇编"><a href="#2-3-汇编" class="headerlink" title="2.3 汇编"></a>2.3 汇编</h2><ul>
<li><p>汇编阶段做的事情就是汇编器（as）将<code>main.s</code>翻译成机器语言指令，把这些指令打包成一种叫做可重定位目标程序的格式，并将结果保存在目标文件<code>main.o</code>（Windows下为<code>xx.obj</code>而Linux下为<code>xx.o</code>）中。<code>main.o</code>是一个二进制文件，如果我们使用文本编辑器打开<code>main.o</code>，会看到一堆乱码。</p>
</li>
<li><p>我们可以使用<code>gcc -c main.s -o main.o</code>得到可重定位目标程序<code>main.o</code></p>
</li>
<li><p>目标文件与可执行文件的组织形式非常类似，<strong>只是有些变量和函数的地址还未确定</strong>（这里其实就是指引用的全局变量和函数），程序不能执行。所以下一步链接的一个重要作用就是找到这些变量和函数的地址。</p>
</li>
</ul>
<h1 id="三、链接"><a href="#三、链接" class="headerlink" title="三、链接"></a>三、链接</h1><ul>
<li><p>链接被分为两步：</p>
<ol>
<li>ELF文件段合并，符号表合并完毕之后，再进行符号解析；</li>
<li>符号重定位。</li>
</ol>
</li>
<li><p>ELF文件段的合并就是将相同的文件段合并在一起，符号解析就是链接器将每个符号的引用和符号定义建立关联。 而重定位就是计算每个定义的符号在虚拟地址空间的绝对地址，然后将可执行文件符号引用处的地址修改为重定位后的地址信息。</p>
</li>
</ul>
<h2 id="3-1-ELF文件"><a href="#3-1-ELF文件" class="headerlink" title="3.1 ELF文件"></a>3.1 ELF文件</h2><ul>
<li>在 Linux 下，将目标文件与可执行文件统称为 ELF文件(Executable and Linkable Format)。目标文件有三种形式：<ol>
<li><strong>可重定位目标文件</strong>：包含二进制代码和数据，其形式可以在编译时与其他可重定位目标文件合并起来，创建一个可执行目标文件，<strong>对应linux的.o和静态链接库</strong>。</li>
<li><strong>可执行目标文件</strong>：包含二进制代码和数据，其形式可以被直接拷贝到存储器中执行，<strong>对应可执行文件</strong>。</li>
<li><strong>共享目标文件</strong>：一种特殊类型的可重定位目标文件，可以再加载或运行时被动态加载到存储器并链接，<strong>对应动态链接库</strong>。</li>
</ol>
</li>
</ul>
<div style="text-align:center;">
    <img src="ELF文件.png" srcset="/img/loading.gif" lazyload alt="ELF文件.png" width="252" class="jop-noMdConv" height="281" style="zoom: 75%;">
</div>

<ul>
<li>ELF文件的段：<ul>
<li><strong>ELF Header文件头</strong>：描述了整个目标文件的属性，包括是否可执行、是动态链接还是静态链接、入口地址是什么、目标硬件、目标操作系统、段表偏移等信息。还会记录<strong>节头部表</strong>的文件偏移，其中条目的大小和数量。节头部表中会描述不同节的位置和大小，每个节都有一个固定大小的条目。</li>
<li><strong>.text代码段</strong>：存放编译后的机器指令，也即各个函数的二进制代码。一个C语言程序由多个函数构成，C语言程序的执行就是函数之间的相互调用。</li>
<li><strong>.rodata：只读数据段</strong>，存放一般的常量、字符串常量等（对应<a target="_blank" rel="noopener" href="https://blog.csdn.net/sinat_23092639/article/details/118443438">漫谈C语言内存管理</a>中说的常量区）。</li>
<li><strong>.data：数据段</strong>，存放已初始化的全局变量和静态变量（对应<a target="_blank" rel="noopener" href="https://blog.csdn.net/sinat_23092639/article/details/118443438">漫谈C语言内存管理</a>中说的全局数据区）。</li>
<li><strong>.bss：</strong>也是数据段（Block Storage Start），但是存放未初始化的全局变量和静态变量，以及所有初始化为0的全局或静态变量。这个段中的数据在程序加载时会被全部初始化为0。</li>
<li><strong>.rel.text、.rel.data</strong>：重定位段，包含了目标文件中需要重定位的全局符号以及重定位入口。</li>
<li><strong>.symtab：符号表</strong>，存放在程序中定义和引用的函数和全局变量的信息。里面存放的是结构体数组，结构体表示“条目”。</li>
<li><strong>.rel.text：</strong>目标文件中的代码会调用别的目标文件中的函数，编译时并不知道调用函数的具体地址，所以在<code>.text</code>段中调用外部函数的跳转指令是空白的，需要在链接的时候修改。而<code>.rel.text</code>的功能就是记录<code>.text</code>段中所有需要链接时修改的位置，被称为重定位条目。</li>
<li><strong>.rel.data：</strong>被当前目标文件引用或者定义的所有全局变量的重定位信息。本质和函数的重定位是相同的道理，但是因为全局变量的位置需要链接的时候确定，无论是自己用的还是向外部提供的都需要链接的时候更改为真正的地址。而目标文件内部的函数调用可以使用PC偏移跳转实现，所以编译时可以确定。</li>
<li><strong>.strtab：</strong>字符串表，主要是符号表中的符号（函数名，全局变量名等）的字符串，可以理解为一堆字符串常量。</li>
</ul>
</li>
</ul>
<h2 id="3-2-符号和符号表"><a href="#3-2-符号和符号表" class="headerlink" title="3.2 符号和符号表"></a>3.2 符号和符号表</h2><ul>
<li><p>变量（函数名）就是地址的助记符，是为了方便人处理而存在的，它们也被称为“符号”，它们的起始地址就成为“符号定义”，当它们被调用的时候也称为符号引用。</p>
<ul>
<li>由当前模块定义，并能被别的模块引用的全局符号。对应当前模块定义的非静态的C函数和全局变量。</li>
<li>由其他模块定义，并被当前模块引用的全局符号。这些称为外部符号，对应在其他模块中定义的非静态的C函数和全局变量。</li>
<li>只被当前模块定义和引用的局部符号。对应当前模块定义的带<code>static</code>属性的C函数和全局变量。</li>
</ul>
</li>
<li><p><code>.symtab</code>符号表中符号条目结构如下：</p>
</li>
</ul>
<div style="text-align:center;">
    <img src="符号表条目.png" srcset="/img/loading.gif" lazyload alt="符号表条目.png" width="363" height="145" class="jop-noMdConv">
</div>

<ul>
<li><code>name</code>表示符号名，就是一个字符串，但这里的字段存储的是在字符串表中的偏移；<code>type</code>表示数据或者函数；<code>binding</code>表示符号是本地的还是全局的；<code>value</code>字段在可重定位模块中是距定义目标的节起始位置的偏移，对于可执行文件是一个绝对运行时地址；<code>size</code>是目标大小。</li>
<li><code>section</code>字段表示这个符号被分配在了目标文件的哪一个节。前面介绍的ELF文件的格式中提到了各种节，但是这里除了这部分存在的节之外，可重定位目标文件还有三个特殊的伪节：<code>ABS</code>表示不该被重定位的符号；<code>UNDEF</code>代表未定义的符号，就是外部符号；<code>COMMON</code>表示还未被分配位置的没有初始化的数据目标。</li>
<li>注意这里的<code>COMMON</code>段存放的是未初始化的全局变量；<code>.bss</code>段存放的是未初始化的静态变量，以及初始化为0的全局或静态变量。如果一个全局变量被分配到了<code>.bss</code>段，就表示它已经被确定存在了，还有一部分的全局变量即使定义了，在链接的时候还会应用重名被删除掉，所以会被放在伪节<code>COMMON</code>段中，等待链接的时候再做处理。</li>
<li>再说下符号表是什么，这对于理解后面的链接本质极为关键。符号表本质上是一种数据库，用来存储代码中的变量，函数调用等相关信息。该表以key-value的方式存储数据。变量和函数的名字就用来对应表中的key部分，value部分包含一系列信息，例如变量的类型，所占据的字节长度，或是函数的返回值。</li>
</ul>
<h2 id="3-3-符号解析"><a href="#3-3-符号解析" class="headerlink" title="3.3 符号解析"></a>3.3 符号解析</h2><ul>
<li><p>链接工作的第一步就是要解析出所有输入的可重定位目标文件的符号表，将代码中的引用和定义关联起来。但是不同的目标文件中可能会定义相同名字的全局符号，比如同名的全局变量（static修饰的全局变量可以不受同名问题影响），以及同名的函数（补充一下只要函数的名字相同就会出现冲突，像C++中提供的函数重载等功能都是在语言的层面去实现的，语言会将函数名的符号解析成函数名+参数列表）。</p>
</li>
<li><p>符号解析阶段会解决符号同名问题，符号分<strong>强&#x2F;弱</strong>：函数名和已初始化的全局变量是强符号；未初始化的全局变量是弱符号。Linux使用下面的规则来处理多重定义的符号名：</p>
<ul>
<li>不允许有多个同名的强符号；</li>
<li>如果有一个强符号和多个弱符号同名，选择强符号；</li>
<li>如果有多个弱符号同名，任意挑选一个。</li>
</ul>
</li>
<li><p>关于符号的同名可能造成很多意外的错误，比如叫做<code>sum</code>的全局变量在A文件中可能是<code>int sum</code>，而在B文件中是<code>long sum</code>，但各自文件在编译的时候都是按照自己定义的类型进行操作的。如果最终链接器选择了<code>int</code>类型，那么B文件在写<code>sum</code>的时候会将对应地址按照<code>long</code>类型来操作。由于两个类型的size不同，会导致修改了别的变量。</p>
</li>
<li><p>关于全面提到的<code>COMMON</code>段和<code>.bss</code>段，就是因为同名符号的处理，那些弱符号不确定是否真的会被定义，所以被放置在伪段交给链接器在链接的时候确定是否要定义这个全局变量。</p>
</li>
</ul>
<h2 id="3-4-重定位"><a href="#3-4-重定位" class="headerlink" title="3.4 重定位"></a>3.4 重定位</h2><ul>
<li>链接简单来说就是在多模块程序中，一个源文件会引用到其他源文件的全局变量或者方法，但是编译成目标文件都是针对单个源文件的，所以此时目标文件并不知道被引用的其他模块的变量或者函数的具体地址。所以此时目标文件中这些被引用的变量或者函数的地址是处于被搁置的状态，而链接就是将这些目标文件合并在一起，让这些被引用的变量或者函数的地址确定下来的过程，即将符号定义的地址填入符号引用处。</li>
<li>重定位包含了两个步骤：第一步是重定位节和符号定义，链接器在符号解析之后将所有同类型的节合并成新的聚合节，此时程序中的每一条指令和全局变量都有确定的地址了；第二步是重定位节中的符号引用，链接器将修<code>.text, .data</code>中对每个符号的引用，这需要<strong>重定位条目</strong>的支持。</li>
<li>解释一下为什么是<code>.text, .data</code>两个段需要做符号的重定位，对外部函数的调用显然是需要重定位的，在代码流程中使用外部的全局变量做运算赋值等显然也是需要的，但以上两点都只会出现在<code>.text</code>段。还有一种是当前文件的全局变量定义时，初始化为外部的全局变量的地址，这时就需要在<code>.data</code>段做重定位了。</li>
</ul>
<h3 id="3-4-1-重定位条目"><a href="#3-4-1-重定位条目" class="headerlink" title="3.4.1 重定位条目"></a>3.4.1 重定位条目</h3><ul>
<li>编译器在编译代码的时候凡是遇到位置未知的目标引用（并不只是外部引用），都会先留白然后记录一条重定位条目，告诉链接器如何进行修改。重定位条目被放在<code>.rel.text, .rel.data</code>。</li>
</ul>
<div style="text-align:center;">
    <img src="重定位条目.png" srcset="/img/loading.gif" lazyload alt="重定位条目.png" width="452" height="139" class="jop-noMdConv">
</div>

<ul>
<li><code>offset</code>是需要被修改的引用相对于所在节的偏移；<code>symbol</code>标识被修改的引用应该指向的符号；<code>type</code>告诉链接器如何修改；<code>addend</code>是一个有符号常数，做偏移调整。</li>
<li>ELF定义32种不同的重定位类型，最基础的两种分别是：<ul>
<li><code>R_X86_64_PC32</code>，重定位一个使用32位PC相对地址的引用。</li>
<li><code>R_X86_64_32</code>，重定位一个使用32位绝对地址的引用。</li>
</ul>
</li>
</ul>
<h3 id="3-4-2-重定位符号引用"><a href="#3-4-2-重定位符号引用" class="headerlink" title="3.4.2 重定位符号引用"></a>3.4.2 重定位符号引用</h3><div style="text-align:center;">
    <img src="重定位算法.png" srcset="/img/loading.gif" lazyload alt="重定位算法.png" width="409" height="221" class="jop-noMdConv">
</div>

<ul>
<li>我们在修改每个目标文件中的重定位符号时，是在原文件中进行修改的，所以我们要修改的地址是各自原目标文件中的地址。第一步<code>refptr = s + r.offset</code>，<code>s</code>表示节的偏移，<code>r.offset</code>是要修改的位置的偏移，所以<code>refptr</code>确定了最后将重定位的结果写在哪里。</li>
<li>函数调用的重定位一般使用PC相对地址，我们先通过<code>ADDR(s)</code>获得当前这个节的运行时地址，然后加上<code>r.offset</code>就是这条要进行重定位指令所在的地址。然后我们通过<code>ADDR(r.symbol)</code>获得调用的函数实际运行地址，于是通过减法就可以计算出PC相对地址了。</li>
<li>全局变量的重定位一般使用绝对地址，直接通过<code>ADDR(r.symbol)</code>获得全局变量的绝对地址写入<code>refptr</code>就行。</li>
</ul>
<h1 id="四、库文件"><a href="#四、库文件" class="headerlink" title="四、库文件"></a>四、库文件</h1><ul>
<li>C&#x2F;C++中的库文件，类似Java的Jar包，本质就是一个压缩文件，里面是实现某个功能模块的各种代码的打包。通过库文件，可以方便地复用代码。比如C 语言标准库中提供有大量的函数，如 <code>scanf(), printf(), strlen()</code> 等，只要在源文件中引入对应的头文件，就可以访问到库文件的函数或者变量。</li>
<li>而这种头文件和库文件相结合的访问机制的好处在于，我们可以通过头文件去对外暴露一些外部要用到的接口和变量的同时，不对外暴露内部实现的源码。</li>
<li>库文件在链接阶段处理，有2种链接方式，一种是<strong>静态链接</strong>，即在生成可执行文件之前链接，另外一种是<strong>动态链接</strong>，即在生成可执行文件之后进行。</li>
</ul>
<h2 id="4-1-静态链接库"><a href="#4-1-静态链接库" class="headerlink" title="4.1 静态链接库"></a>4.1 静态链接库</h2><ul>
<li>静态链接库（<code>.a</code>文件）就是将整个库文件在生成可执行文件之前的链接阶段都打包到可执行文件中。</li>
</ul>
<p><strong>优势是：</strong></p>
<ol>
<li>可执行文件可以独立运行，无需另外带上库文件</li>
<li>相对于动态链接库，可以在运行的时候节省链接的时间（不过几乎可以忽略）</li>
</ol>
<p><strong>劣势是：</strong></p>
<ol>
<li>一旦库文件需要更改，整个可执行文件都要重新链接生成新的可执行文件。</li>
<li>和使用动态链接库生成的可执行文件相比，静态链接库生成的可执行文件的体积更大，所以更占用磁盘空间。</li>
<li>系统中如果有多个运行的程序都使用到同一个库文件，则都需要加载到内存而导致内存空间的浪费。</li>
</ol>
<h2 id="4-2-动态链接库"><a href="#4-2-动态链接库" class="headerlink" title="4.2 动态链接库"></a>4.2 动态链接库</h2><ul>
<li>动态链接库（<code>.so</code>文件）则是在运行时才链接到可执行文件中。</li>
</ul>
<p><strong>优势是：</strong></p>
<ol>
<li>一旦库文件需要更改，只需要更换库文件即可，可执行程序无需修改。</li>
<li>和使用静态链接库生成的可执行文件相比，使用动态链接库的可执行文件的体积更小，所以更省磁盘空间。</li>
<li>系统中如果有多个运行的程序使用到该库文件，可以复用一部分空间，即不会造成内存空间的浪费。（强调一下，同时运行的多个程序在内存中复用同一个动态库的代码段等，系统内存中只存一份）。</li>
</ol>
<p><strong>劣势是：</strong></p>
<ol>
<li>可执行文件不可以独立运行，需另外带上库文件</li>
<li>相对于静态链接库，在运行的时候会增加动态链接的时间（不过几乎可以忽略）</li>
</ol>
<h1 id="五、动态链接"><a href="#五、动态链接" class="headerlink" title="五、动态链接"></a>五、动态链接</h1><ul>
<li>对于动态共享库而言，主要目的就是允许多个正在运行的继承共享内存中的相同库代码，这里遇到的问题就是多个进程如何共享一个库的代码呢？</li>
<li>方法一：给每个共享库事先分配一个块专用的地址空间，要求加载器总在这个地址加载共享库。但是存在如下的缺点：<ol>
<li>对地址空间使用效率不高，因为即使不加载这个共享库，这部分空间依旧得分配出来。</li>
<li>一旦库被修改，还要调整这块分配的空间，这使得它难以管理</li>
<li>如果共享库很多，就很容易出现地址空间之间出现许多不能使用的内存碎片空间</li>
</ol>
</li>
<li>方法二： <strong>基于方法一的种种缺点，所以出现了“与位置无关的代码”，目的是让库代码可以在任意地址加载执行。（即用相对地址）</strong></li>
</ul>
<h2 id="5-1-位置无关代码"><a href="#5-1-位置无关代码" class="headerlink" title="5.1 位置无关代码"></a>5.1 位置无关代码</h2><ul>
<li>可以加载而无需重定位的代码称为位置无关代码<code>(Position-Independent Code, PIC)</code>，<code>GCC</code>编译的时候使用<code>-fpic</code>选项指示生成<code>PIC</code>代码。</li>
<li>首先要知道的是，在一个目标模块（包含共享目标模块）中，数据段总是在代码段后面的，代码段和数据段之间的相对距离固定，和代码段和数据段的绝对地址无关。一个目标模块内部的符号的引用可以使用PC相对寻址来实现引用，所以一个目标模块内的的调用或者引用偏移量是已知的，所以本身就是PIC代码。但是对于别的目标模块的函数调用和全局变量引用就需要处理为PIC，在链接时重定位。</li>
<li>在生成PIC代码的时候，编译器会在数据段开始创建一张全局偏移量表<code>(Global Offset Table, GOT)</code>，<code>GOT</code>包含每个被这个目标木块引用的全局数据目标的表目，然后给每个表目生成一个重定位记录，在加载动态库时，动态链接器会重定位<code>GOT</code>的每个表目，使得它包含正确的位置。</li>
<li>在代码中的指令会直接写到<code>GOT[x]</code>位置取调用函数的地址，或者全局变量的地址。而加载动态库的时候根据加载的位置修改<code>GOT</code>数组。</li>
</ul>
<h2 id="5-2-PIC数据引用"><a href="#5-2-PIC数据引用" class="headerlink" title="5.2 PIC数据引用"></a>5.2 PIC数据引用</h2><div style="text-align:center;">
    <img src="PIC数据引用.png" srcset="/img/loading.gif" lazyload alt="PIC数据引用.png" width="351" height="169" class="jop-noMdConv">
</div>

<ul>
<li>对于全局变量引用的加载，是在加载动态库的时候就完成对所有引用的全局变量，对应的<code>GOT</code>数组中绝对地址的写入。</li>
<li>此后代码在运行的时候就可以通过<code>GOT</code>数组直接查到全局变量的绝对地址。</li>
</ul>
<h2 id="5-3-PIC函数调用"><a href="#5-3-PIC函数调用" class="headerlink" title="5.3 PIC函数调用"></a>5.3 PIC函数调用</h2><div style="text-align:center;">
    <img src="PIC函数引用.png" srcset="/img/loading.gif" lazyload alt="PIC函数引用.png" width="408" height="271" class="jop-noMdConv">
</div>

<ul>
<li><p>函数的重定位引入了延迟绑定的概念，每个外部函数都有对应的<code>GOT</code>空间存储函数的绝对地址，但不是像全局变量在加载的时候就完成对所有函数对应的<code>GOT</code>的更改，而是将函数地址的绑定推迟到第一次调用该函数时。这样可以避免去绑定很多根本不会调用到的函数，注意代码中有写调用某个函数，实际执行流程不一定会走到调用该函数。</p>
</li>
<li><p>延迟绑定引入了过程链接表<code>(Procedure Linkage Table, PLT)</code>，<code>PLT</code>是代码段的一部分而<code>GOT</code>在数据段。</p>
</li>
<li><p>上图(a)展示了<code>GOT</code>和<code>PLT</code> 如何协同工作，在<code>addvec()</code>被第一次调用时，延迟解析它的运行时地址：</p>
<ul>
<li>第1步。不直接调用<code>addvec</code>，程序调用进人<code>PIT[2]</code>，这是<code>addvec</code>的<code>PLT</code>条目；</li>
<li>第2步。第一条<code>PLT</code>指令通过<code>GOT[4]</code>进行间接跳转。因为每个<code>GOT</code>条目初姶时都指向它对应的 <code>PLT</code> 条目的第二条指令，这个间接跳转只是简单地把控制传送回<code>PIT[2]</code>中的下一条指令；</li>
<li>第3步。在把<code>addvec</code>的<code>ID(0x1)</code>压人栈中之后，<code>PIT[2]</code>跳转到 <code>PIT[0]</code>；</li>
<li>第4步。<code>PIT[0]</code>通过<code>GOT[1]</code>间接地把动态链接器的一个参数压人栈中，然后通过<code>GOT[2]</code>问接跳转进动态链接器中。动态链接器使用两个栈条目来确定<code>addvec</code>的运行时位置，用这个地址重写<code>GOT[4]</code>，再把控制传递给<code>addvec</code>。</li>
</ul>
</li>
<li><p>图(b)给出的是后续再调用<code>addvec</code>时的控制流：</p>
<ul>
<li>第1步。和前面一样，控制传递到<code>PIT[2]</code>；</li>
<li>第2步。不过这次通过<code>GOT[4]</code>的间接跳转会将控制直接转移到<code>addvec</code>。</li>
</ul>
</li>
</ul>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/C-C/" class="category-chain-item">C/C++</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/C-C/" class="print-no-link">#C/C++</a>
      
        <a href="/tags/%E7%BC%96%E8%AF%91%E9%93%BE%E6%8E%A5/" class="print-no-link">#编译链接</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>C++编译与链接</div>
      <div>https://lluvialuo.github.io/2024/05/21/C-编译与链接/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>Lluvia Luo</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2024年5月21日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2024/05/17/Makefile%E7%AC%94%E8%AE%B0/" title="Makefile笔记">
                        <span class="hidden-mobile">Makefile笔记</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  
  
    <article id="comments" lazyload>
      
  <div id="valine"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#valine', function() {
      Fluid.utils.createScript('https://lib.baomitu.com/valine/1.5.1/Valine.min.js', function() {
        var options = Object.assign(
          {"appId":"GYXWwiquLells7Jk5YnXDL14-gzGzoHsz","appKey":"ZwOt64lE5AeeAOjGF9nhJl9b","path":"window.location.pathname","placeholder":"说点什么。。。","avatar":"retro","meta":["nick","mail","link"],"requiredFields":[],"pageSize":10,"lang":"zh-CN","highlight":false,"recordIP":false,"serverURLs":"","emojiCDN":null,"emojiMaps":null,"enableQQ":false},
          {
            el: "#valine",
            path: window.location.pathname
          }
        )
        new Valine(options);
        Fluid.utils.waitElementVisible('#valine .vcontent', () => {
          var imgSelector = '#valine .vcontent img:not(.vemoji)';
          Fluid.plugins.imageCaption(imgSelector);
          Fluid.plugins.fancyBox(imgSelector);
        })
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


    </article>
  


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="leancloud-site-pv-container" style="display: none">
        总访问量 
        <span id="leancloud-site-pv"></span>
         次
      </span>
    
    
      <span id="leancloud-site-uv-container" style="display: none">
        总访客数 
        <span id="leancloud-site-uv"></span>
         人
      </span>
    
    

  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script defer src="/js/leancloud.js" ></script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
